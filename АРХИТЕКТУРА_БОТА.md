# АРХИТЕКТУРА И ЛОГИКА РАБОТЫ БОТА
## MAX Productivity Bot - Детальная архитектура с направлениями масштабирования

---

## 1. ОБЩАЯ АРХИТЕКТУРА СИСТЕМЫ

```mermaid
graph TB
    subgraph "Внешние сервисы"
        A[MAX Messenger API]
        B[GigaChat API]
    end
    
    subgraph "Bot Application Layer"
        C[Bot Instance<br/>@maxhub/max-bot-api]
        D[App Class<br/>Оркестратор]
    end
    
    subgraph "Service Layer"
        E[Message Service]
        F[Task Service]
        G[Digest Service]
        H[Assistant Service]
        I[Search Service]
        J[Calendar Service]
        K[Reminder Service]
        L[User Chat Service]
        M[Material Service]
    end
    
    subgraph "Infrastructure Layer"
        N[(PostgreSQL<br/>Prisma ORM)]
        O[Node Schedule<br/>Планировщик]
        P[Logger<br/>Pino]
    end
    
    subgraph "AI Integration"
        Q[GigaChat Service<br/>LLM Wrapper]
    end
    
    A -->|Webhook/Polling| C
    C -->|События| D
    D -->|Обработка| E
    D -->|Обработка| F
    D -->|Обработка| G
    D -->|Обработка| H
    
    E -->|Сохранение| N
    F -->|Сохранение| N
    F -->|Использование| Q
    G -->|Использование| Q
    H -->|Использование| Q
    
    Q -->|Запросы| B
    F -->|Планирование| K
    K -->|Использование| O
    O -->|Отправка| D
    
    D -->|Ответы| C
    C -->|Уведомления| A
    
    style A fill:#c5e1f5
    style B fill:#f48fb1
    style C fill:#90caf9
    style D fill:#64b5f6
    style N fill:#ffccbc
    style Q fill:#f48fb1
```

---

## 2. ЛОГИКА ИНИЦИАЛИЗАЦИИ И ЗАПУСКА

```mermaid
graph TD
    A[Запуск приложения<br/>index.ts] -->|bootstrap| B[Создание App instance]
    
    B -->|init| C[Подключение к БД<br/>connectDatabase]
    C -->|Prisma Client| D[(PostgreSQL)]
    
    C -->|Инициализация| E[Reminder Service Init]
    E -->|Восстановление напоминаний| F[Node Schedule]
    
    C -->|Инициализация| G[Scheduled Digest Init]
    G -->|Планирование дайджестов| F
    
    C -->|Настройка| H[Assistant Service<br/>setBotApi]
    C -->|Настройка| I[Digest Service<br/>setBotApi]
    
    C -->|Предзагрузка| J[Загрузка welcome image]
    J -->|uploadImage| K[MAX API]
    K -->|Токен| L[Сохранение в памяти]
    
    C -->|Регистрация| M[Register Handlers]
    M -->|Команды| N[Command Handlers]
    M -->|События| O[Event Handlers]
    M -->|Middleware| P[Error Handlers]
    
    C -->|start| Q[Получение Bot Info]
    Q -->|getMyInfo| K
    Q -->|Retry Logic| R{Успех?}
    
    R -->|Нет| S[Повтор через 2-4-6 сек]
    S --> Q
    R -->|Да| T[Запуск Polling]
    
    T -->|start| U[Цикл получения обновлений]
    U -->|getUpdates| K
    U -->|Обработка| V[Обработчики событий]
    
    style A fill:#e1f5ff
    style D fill:#ffccbc
    style K fill:#c5e1f5
    style T fill:#c8e6c9
    style U fill:#90caf9
```

---

## 3. ОБРАБОТКА ВХОДЯЩИХ СООБЩЕНИЙ

```mermaid
graph TD
    A[MAX API<br/>Новое сообщение] -->|Polling| B[Bot Instance]
    B -->|Событие| C[Middleware Layer]
    
    C -->|Проверка| D{Тип события?}
    
    D -->|message_created| E[handleIncomingMessage]
    D -->|bot_started| F[Приветствие]
    D -->|message_callback| G[Button Handlers]
    D -->|command| H[Command Handlers]
    
    E -->|Парсинг| I{Тип чата?}
    
    I -->|Личный диалог| J{Первый раз?}
    I -->|Групповой чат| K{Бот упомянут?}
    
    J -->|Да| L[Приветствие + меню]
    J -->|Нет| M{Активный чат?}
    
    M -->|Нет| N[Предложение выбрать чат]
    M -->|Да| O[Assistant Service<br/>Ответ на вопрос]
    
    K -->|Да| P[Обработка с ответом]
    K -->|Нет| Q[Тихая обработка]
    
    P -->|Извлечение| R[Task Service]
    Q -->|Извлечение| R
    
    R -->|Сохранение| S[Message Service]
    S -->|В БД| T[(PostgreSQL)]
    
    R -->|GigaChat| U[Task Extraction]
    U -->|Сохранение| V[Task Table]
    U -->|Создание| W[Reminder Service]
    
    O -->|GigaChat| X[Personal Assistant]
    X -->|Ответ| Y[Отправка пользователю]
    
    style A fill:#c5e1f5
    style T fill:#ffccbc
    style U fill:#f48fb1
    style X fill:#f48fb1
    style Y fill:#c8e6c9
```

---

## 4. ОБРАБОТКА КОМАНД

```mermaid
graph TD
    A[Пользователь:<br/>Команда] -->|Событие| B[Command Router]
    
    B -->|/start| C[Приветствие<br/>+ Главное меню]
    B -->|/help| D[Справка]
    B -->|/digest| E[Digest Handler]
    B -->|/deadlines| F[Deadlines Handler]
    B -->|/calendar| G[Calendar Handler]
    B -->|/search| H[Search Handler]
    B -->|/materials| I[Materials Handler]
    B -->|/tasks| J[Tasks Handler]
    B -->|/chats| K[Chats Handler]
    
    E -->|Парсинг периода| L{Период валиден?}
    L -->|Нет| M[Ошибка формата]
    L -->|Да| N{Активный чат?}
    
    N -->|Нет| O[Выбор чата]
    N -->|Да| P[Digest Service]
    P -->|Сбор данных| Q[(БД)]
    P -->|GigaChat| R[Генерация дайджеста]
    R -->|Markdown| S[Отправка]
    
    F -->|Получение задач| T[Task Service]
    T -->|Фильтрация| U[7 дней вперед]
    U -->|Форматирование| S
    
    G -->|Персональные задачи| T
    T -->|Все чаты| V[Calendar Service]
    V -->|ICS генерация| W[Отправка файла]
    
    H -->|Параллельный поиск| X[Search Service]
    X -->|Материалы| Y[(Materials)]
    X -->|Сообщения| Z[(Messages)]
    Y -->|Результаты| S
    Z -->|Результаты| S
    
    I -->|Все материалы| Y
    Y -->|Дедупликация| AA[Форматирование]
    AA -->|Markdown ссылки| S
    
    J -->|Все задачи| T
    T -->|Группировка| S
    
    K -->|Синхронизация| AB[User Chat Service]
    AB -->|MAX API| AC[getAllChats]
    AC -->|Проверка членства| AD[getChatMembers]
    AD -->|Сохранение| Q
    
    style A fill:#e1f5ff
    style Q fill:#ffccbc
    style R fill:#f48fb1
    style S fill:#c8e6c9
    style AC fill:#c5e1f5
```

---

## 5. ИЗВЛЕЧЕНИЕ И ОБРАБОТКА ЗАДАЧ

```mermaid
graph TD
    A[Новое сообщение] -->|Событие| B[Task Service<br/>processIncomingMessage]
    
    B -->|Проверка| C{GigaChat<br/>доступен?}
    
    C -->|Нет| D[Пропуск извлечения]
    C -->|Да| E[Получение контекста]
    
    E -->|10 последних| F[(Messages Table)]
    E -->|Существующие задачи| G[(Tasks Table)]
    
    F -->|Формирование| H[Промпт для ИИ]
    G -->|Предотвращение дублей| H
    
    H -->|Запрос| I[GigaChat Service<br/>extractTasks]
    I -->|Авторизация| J{Токен валиден?}
    
    J -->|Нет| K[Получение токена]
    K -->|OAuth2/Bearer| L[GigaChat API<br/>/api/v2/oauth]
    L -->|Токен| M[Кэширование]
    
    J -->|Да| N[Запрос к API]
    M --> N
    
    N -->|/api/v1/chat/completions| O[GigaChat API]
    O -->|JSON ответ| P[Парсинг задач]
    
    P -->|Парсинг дат| Q{Дата валидна?}
    Q -->|Относительная| R[chrono-node<br/>Парсинг]
    Q -->|ISO8601| S[Прямой парсинг]
    
    R -->|Date объект| T[Сохранение в БД]
    S -->|Date объект| T
    
    T -->|Task Table| U[(PostgreSQL)]
    T -->|Создание| V[Reminder Service]
    
    V -->|Расчет времени| W[Дедлайн - 2 часа]
    W -->|Планирование| X[Node Schedule]
    X -->|В БД| Y[(Reminders Table)]
    
    style A fill:#e1f5ff
    style I fill:#f48fb1
    style O fill:#f48fb1
    style U fill:#ffccbc
    style X fill:#ffccbc
```

---

## 6. ГЕНЕРАЦИЯ ДАЙДЖЕСТОВ

```mermaid
graph TD
    A[Команда /digest] -->|Запрос| B[Digest Service<br/>generateDigest]
    
    B -->|Парсинг периода| C{Период определен?}
    C -->|Нет| D[Ошибка]
    C -->|Да| E[Сбор данных]
    
    E -->|Сообщения| F[(Messages Table)]
    E -->|Задачи| G[(Tasks Table)]
    E -->|Материалы| H[(Materials Table)]
    E -->|Участники| I[MAX API<br/>getChatMembers]
    
    F -->|Фильтрация по дате| J[До 200 сообщений]
    G -->|Группировка| K[По датам]
    H -->|Дедупликация| L[Уникальные материалы]
    
    J -->|Формирование| M[Промпт для ИИ]
    K -->|Контекст| M
    L -->|Контекст| M
    I -->|Участники и роли| M
    
    M -->|Запрос| N[GigaChat Service<br/>summarizeChat]
    N -->|Авторизация| O{Токен валиден?}
    
    O -->|Нет| P[Получение токена]
    O -->|Да| Q[Запрос к API]
    P --> Q
    
    Q -->|/api/v1/chat/completions| R[GigaChat API]
    R -->|Дайджест| S{Успех?}
    
    S -->|Да| T[Markdown форматирование]
    S -->|Нет| U[Fallback дайджест]
    
    T -->|Отправка| V[Пользователю]
    U -->|Шаблон| V
    
    V -->|Логирование| W[(DigestLog Table)]
    
    style A fill:#e1f5ff
    style N fill:#f48fb1
    style R fill:#f48fb1
    style T fill:#c8e6c9
    style W fill:#ffccbc
```

---

## 7. ПЕРСОНАЛЬНЫЙ АССИСТЕНТ

```mermaid
graph TD
    A[Вопрос в личке] -->|Событие| B[Assistant Service<br/>answerPersonalQuestion]
    
    B -->|Проверка| C{Активный чат?}
    C -->|Нет| D[Предложение выбрать чат]
    C -->|Да| E[Сбор контекста]
    
    E -->|100 сообщений| F[(Messages Table)]
    E -->|Задачи пользователя| G[(Tasks Table)]
    E -->|Материалы чата| H[(Materials Table)]
    E -->|Участники| I[MAX API<br/>getChatMembers]
    
    F -->|История| J[Формирование промпта]
    G -->|Персональные задачи| J
    H -->|Доступные материалы| J
    I -->|Роли участников| J
    
    J -->|Запрос| K[GigaChat Service<br/>complete]
    K -->|Авторизация| L{Токен валиден?}
    
    L -->|Нет| M[Получение токена]
    L -->|Да| N[Запрос к API]
    M --> N
    
    N -->|/api/v1/chat/completions| O[GigaChat API]
    O -->|Ответ ИИ| P{Успех?}
    
    P -->|Да| Q[Форматирование ответа]
    P -->|Нет| R[Fallback ответ]
    
    Q -->|Отправка| S[Пользователю]
    R -->|Шаблон| S
    
    style A fill:#e1f5ff
    style K fill:#f48fb1
    style O fill:#f48fb1
    style S fill:#c8e6c9
```

---

## 8. СИСТЕМА НАПОМИНАНИЙ

```mermaid
graph TD
    A[Задача создана<br/>с дедлайном] -->|Событие| B[Reminder Service<br/>createReminder]
    
    B -->|Расчет| C[Время напоминания<br/>Дедлайн - 2 часа]
    C -->|Сохранение| D[(Reminders Table)]
    
    D -->|При инициализации| E[Reminder Service Init]
    E -->|Восстановление| F[Загрузка всех<br/>недоставленных]
    
    F -->|Для каждого| G[Планирование]
    G -->|Node Schedule| H[scheduleJob]
    
    H -->|Ожидание| I{Время наступило?}
    I -->|Нет| J[Продолжение ожидания]
    I -->|Да| K[Получение задачи]
    
    K -->|Из БД| L[(Tasks Table)]
    L -->|Проверка| M{Задача актуальна?}
    
    M -->|Нет| N[Пропуск напоминания]
    M -->|Да| O[Формирование текста]
    
    O -->|Текст| P[Отправка в личку]
    P -->|MAX API| Q[sendMessage]
    Q -->|Успех| R[Отметка о доставке]
    
    R -->|Обновление| D
    R -->|delivered = true| S[Завершение]
    
    style A fill:#e1f5ff
    style H fill:#ffccbc
    style Q fill:#c5e1f5
    style R fill:#c8e6c9
```

---

## 9. УПРАВЛЕНИЕ ЧАТАМИ

```mermaid
graph TD
    A[Пользователь:<br/>/chats] -->|Действие| B[User Chat Service<br/>getUserChats]
    
    B -->|Проверка| C{Список пуст?}
    C -->|Да| D[Автосинхронизация]
    C -->|Нет| E[Показ списка]
    
    D -->|Запрос| F[MAX API<br/>getAllChats]
    F -->|Список чатов| G[Для каждого чата]
    
    G -->|Проверка| H[MAX API<br/>getChatMembers]
    H -->|Участники| I{Пользователь<br/>участник?}
    
    I -->|Нет| J[Пропуск чата]
    I -->|Да| K[Сохранение/обновление]
    
    K -->|UserChat Table| L[(PostgreSQL)]
    J -->|Следующий| G
    
    E -->|Выбор| M[Пользователь выбирает]
    L -->|Список| M
    
    M -->|Установка| N[selectChat]
    N -->|Обновление| O[UserPreference<br/>selectedChatId]
    O -->|В БД| P[(UserPreferences Table)]
    
    P -->|Подтверждение| Q[Отправка пользователю]
    
    style A fill:#e1f5ff
    style F fill:#c5e1f5
    style H fill:#c5e1f5
    style L fill:#ffccbc
    style Q fill:#c8e6c9
```

---

## 10. ОБРАБОТКА МАТЕРИАЛОВ

```mermaid
graph TD
    A[Сообщение с вложением] -->|Событие| B[Message Service<br/>extractMaterials]
    
    B -->|Парсинг| C{Тип вложения?}
    
    C -->|Файл| D[type: file<br/>title: fileName]
    C -->|Изображение| E[type: image<br/>title: фотка]
    C -->|Видео| F[type: video<br/>title: fileName]
    C -->|Ссылка| G[type: share<br/>title: заголовок]
    
    D -->|Метаданные| H[Сохранение материала]
    E -->|Метаданные| H
    F -->|Метаданные| H
    G -->|Метаданные| H
    
    H -->|Materials Table| I[(PostgreSQL)]
    
    H -->|Проверка| J{Тип анализируемый?<br/>share или file}
    
    J -->|Да| K[Асинхронный анализ]
    J -->|Нет| L[Завершение]
    
    K -->|Запрос| M[GigaChat Service<br/>analyzeMaterial]
    M -->|Авторизация| N{Токен валиден?}
    
    N -->|Нет| O[Получение токена]
    N -->|Да| P[Запрос к API]
    O --> P
    
    P -->|/api/v1/chat/completions| Q[GigaChat API]
    Q -->|Описание| R[Обновление материала]
    
    R -->|description| I
    R -->|Готов к использованию| S[Поиск и отображение]
    
    style A fill:#e1f5ff
    style M fill:#f48fb1
    style Q fill:#f48fb1
    style I fill:#ffccbc
    style S fill:#c8e6c9
```

---

## 11. ПОТОК ДАННЫХ В СИСТЕМЕ

```mermaid
graph TD
    A[MAX Messenger] -->|Входящие события| B[Bot Instance]
    B -->|Обработка| C[App Class]
    
    C -->|Сохранение| D[Message Service]
    D -->|Запись| E[(Messages)]
    
    C -->|Извлечение| F[Task Service]
    F -->|Запрос| G[GigaChat API]
    G -->|Ответ| F
    F -->|Запись| H[(Tasks)]
    
    F -->|Создание| I[Reminder Service]
    I -->|Запись| J[(Reminders)]
    
    C -->|Извлечение| K[Material Service]
    K -->|Запись| L[(Materials)]
    K -->|Анализ| G
    G -->|Описание| K
    K -->|Обновление| L
    
    C -->|Запросы| M[Digest Service]
    M -->|Чтение| E
    M -->|Чтение| H
    M -->|Чтение| L
    M -->|Запрос| G
    G -->|Дайджест| M
    M -->|Запись| N[(DigestLog)]
    
    C -->|Запросы| O[Search Service]
    O -->|Чтение| E
    O -->|Чтение| L
    
    C -->|Запросы| P[Calendar Service]
    P -->|Чтение| H
    P -->|Генерация| Q[ICS-файл / Excel-файл]
    
    C -->|Запросы| R[Assistant Service]
    R -->|Чтение| E
    R -->|Чтение| H
    R -->|Чтение| L
    R -->|Запрос| G
    G -->|Ответ| R
    
    C -->|Управление| S[User Chat Service]
    S -->|Запрос| T[MAX API]
    T -->|Список чатов| S
    S -->|Запись| U[(UserChats)]
    
    style A fill:#c5e1f5
    style G fill:#f48fb1
    style T fill:#c5e1f5
    style E fill:#ffccbc
    style H fill:#ffccbc
    style L fill:#ffccbc
```

---

## 12. НАПРАВЛЕНИЯ ДЛЯ МАСШТАБИРОВАНИЯ

```mermaid
graph TD
    A[Текущая архитектура] -->|Горизонтальное масштабирование| B[Множественные инстансы бота]
    A -->|Вертикальное масштабирование| C[Оптимизация БД]
    A -->|Кэширование| D[Redis Cache Layer]
    A -->|Очереди| E[Message Queue]
    A -->|Микросервисы| F[Разделение сервисов]
    
    B -->|Load Balancer| G[Распределение нагрузки]
    B -->|Shared State| H[Redis для состояния]
    
    C -->|Индексы| I[Оптимизация запросов]
    C -->|Партиционирование| J[Разделение таблиц]
    C -->|Read Replicas| K[Репликация БД]
    
    D -->|Кэш токенов| L[GigaChat токены]
    D -->|Кэш результатов| M[Дайджесты]
    D -->|Кэш чатов| N[Списки чатов]
    
    E -->|Асинхронная обработка| O[Task Queue]
    E -->|Обработка материалов| P[Material Queue]
    E -->|Напоминания| Q[Reminder Queue]
    
    F -->|API Gateway| R[Единая точка входа]
    F -->|Task Service| S[Отдельный сервис]
    F -->|Digest Service| T[Отдельный сервис]
    F -->|Assistant Service| U[Отдельный сервис]
    
    style A fill:#e1f5ff
    style B fill:#c8e6c9
    style D fill:#fff9c4
    style E fill:#ffccbc
    style F fill:#f48fb1
```

---

## 13. КОМПОНЕНТЫ И ИХ ОТВЕТСТВЕННОСТЬ

### 13.1. Application Layer
- **App Class**: Главный оркестратор, регистрация обработчиков, управление жизненным циклом
- **Bot Instance**: Обертка над MAX Bot API, обработка событий, отправка сообщений

### 13.2. Service Layer
- **Message Service**: Сохранение и извлечение сообщений из БД
- **Task Service**: Извлечение задач из сообщений через GigaChat, управление задачами
- **Digest Service**: Генерация дайджестов обсуждений
- **Assistant Service**: Ответы на персональные вопросы пользователей
- **Search Service**: Поиск по материалам и сообщениям
- **Calendar Service**: Экспорт задач в календарь (ICS и Excel)
- **Reminder Service**: Планирование и отправка напоминаний
- **User Chat Service**: Управление списком чатов пользователя
- **Material Service**: Извлечение и анализ материалов

### 13.3. Infrastructure Layer
- **PostgreSQL + Prisma**: Хранение данных, миграции, ORM
- **Node Schedule**: Планирование задач (напоминания, дайджесты)
- **Logger (Pino)**: Структурированное логирование

### 13.4. AI Integration
- **GigaChat Service**: Обертка над GigaChat API, управление токенами, запросы к LLM

---

## 14. ОБРАБОТКА ОШИБОК И УСТОЙЧИВОСТЬ

```mermaid
graph TD
    A[Любая операция] -->|Выполнение| B{Ошибка?}
    
    B -->|Нет| C[Успешное выполнение]
    B -->|Да| D[Тип ошибки?]
    
    D -->|Сетевая ошибка| E[Retry Logic]
    D -->|Ошибка БД| F[Логирование + Fallback]
    D -->|Ошибка GigaChat| G[Fallback ответ]
    D -->|Критичная ошибка| H[Логирование + Уведомление]
    
    E -->|Повтор| I{Максимум попыток?}
    I -->|Нет| A
    I -->|Да| F
    
    F -->|Альтернативный путь| J{Fallback доступен?}
    J -->|Да| K[Использование Fallback]
    J -->|Нет| L[Ошибка пользователю]
    
    G -->|Шаблонный ответ| M[Отправка пользователю]
    K -->|Альтернативный результат| M
    
    H -->|Мониторинг| N[Система логирования]
    N -->|Алерты| O[Уведомления администратора]
    
    style A fill:#e1f5ff
    style C fill:#c8e6c9
    style E fill:#fff9c4
    style G fill:#fff9c4
    style H fill:#ef5350
    style M fill:#c8e6c9
```

---

## 15. БЕЗОПАСНОСТЬ И КОНФИДЕНЦИАЛЬНОСТЬ

```mermaid
graph TD
    A[Запрос пользователя] -->|Проверка| B{Тип запроса?}
    
    B -->|Выбор чата| C[Проверка членства]
    B -->|Дайджест| C
    B -->|Задачи| C
    B -->|Материалы| C
    
    C -->|MAX API| D[getChatMembers]
    D -->|Участники| E{Пользователь<br/>в списке?}
    
    E -->|Нет| F[Отказ в доступе]
    E -->|Да| G[Разрешение доступа]
    
    G -->|Обработка| H[Выполнение запроса]
    H -->|Логирование| I[Структурированные логи]
    
    I -->|Без секретов| J[Только метаданные]
    J -->|Хранение| K[(Logs)]
    
    style A fill:#e1f5ff
    style D fill:#c5e1f5
    style F fill:#ef5350
    style G fill:#c8e6c9
    style K fill:#ffccbc
```

---

## 16. ПРОИЗВОДИТЕЛЬНОСТЬ И ОПТИМИЗАЦИЯ

### 16.1. Текущие оптимизации
-  Предзагрузка welcome image при старте
-  Кэширование GigaChat токенов
-  Индексы в БД для частых запросов
-  Дедупликация материалов
-  Ограничение количества сообщений для анализа (200)
-  Асинхронная обработка материалов через ИИ

### 16.2. Потенциальные улучшения
-  Redis для кэширования результатов
-  Message Queue для асинхронной обработки
-  Connection Pooling для БД
-  Batch processing для массовых операций
-  CDN для статических ресурсов

---

## ЗАКЛЮЧЕНИЕ

Архитектура бота построена на принципах:
-  **Модульность**: Разделение на независимые сервисы
-  **Масштабируемость**: Возможность горизонтального и вертикального масштабирования
-  **Надежность**: Обработка ошибок, retry-логика, fallback-механизмы
-  **Безопасность**: Проверка доступа, конфиденциальность данных
-  **Производительность**: Оптимизация запросов, кэширование, асинхронная обработка

Система готова к использованию в production и может быть расширена для больших нагрузок.

