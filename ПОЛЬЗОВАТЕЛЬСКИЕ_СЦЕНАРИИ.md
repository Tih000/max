# ПОЛЬЗОВАТЕЛЬСКИЕ СЦЕНАРИИ И АРХИТЕКТУРА БОТА
## MAX Productivity Bot - Схемы взаимодействия

---

## 1. ОБЩАЯ АРХИТЕКТУРА СИСТЕМЫ

```mermaid
graph TB
    A[Пользователь MAX] -->|Сообщения/Команды| B[MAX Messenger API]
    B -->|Webhook/Polling| C[Bot Application]
    
    C -->|Обработка| D[Message Service]
    C -->|Команды| E[Command Handlers]
    C -->|Вопросы| F[Assistant Service]
    
    D -->|Сохранение| G[(PostgreSQL)]
    D -->|Извлечение задач| H[Task Service]
    D -->|Извлечение материалов| I[Material Service]
    
    H -->|Сохранение| G
    H -->|Создание напоминаний| J[Reminder Service]
    
    F -->|Запрос к ИИ| K[GigaChat API]
    E -->|Генерация дайджестов| L[Digest Service]
    L -->|Запрос к ИИ| K
    
    J -->|Планирование| M[Node Schedule]
    M -->|Отправка| C
    
    C -->|Ответы| B
    B -->|Уведомления| A
    
    style A fill:#e1f5ff
    style B fill:#c5e1f5
    style C fill:#90caf9
    style G fill:#ffccbc
    style K fill:#f48fb1
```

---

## 2. СЦЕНАРИЙ: ПЕРВОЕ ВЗАИМОДЕЙСТВИЕ С БОТОМ

```mermaid
graph TD
    A[Пользователь отправляет<br/>любое сообщение в личку] -->|Событие| B{Проверка:<br/>первый раз?}
    
    B -->|Да| C[Создание UserPreference]
    C --> D[Получение имени пользователя]
    D --> E[Получение активного чата]
    E --> F[Формирование приветствия]
    F --> G[Загрузка изображения<br/>start_photo.png]
    G --> H[Формирование главного меню]
    H --> I[Отправка приветствия<br/>с изображением и кнопками]
    
    B -->|Нет| J[Обычная обработка]
    
    I --> K[Пользователь видит<br/>приветственное сообщение]
    
    style A fill:#e1f5ff
    style I fill:#c8e6c9
    style K fill:#fff9c4
```

---

## 3. СЦЕНАРИЙ: РАБОТА С ДАЙДЖЕСТАМИ

```mermaid
graph TD
    A[Пользователь:<br/>/digest неделя] -->|Команда| B[Парсинг аргументов]
    B --> C{Период<br/>определен?}
    
    C -->|Нет| D[Ошибка:<br/>неверный формат]
    C -->|Да| E{Активный чат<br/>выбран?}
    
    E -->|Нет| F[Предложение выбрать чат]
    F --> G[Показ списка чатов]
    
    E -->|Да| H[Получение сообщений<br/>из БД за период]
    H --> I[Получение задач<br/>за период]
    I --> J[Получение материалов<br/>за период]
    J --> K[Получение участников чата]
    
    K --> L{GigaChat<br/>доступен?}
    
    L -->|Да| M[Формирование промпта<br/>для ИИ]
    M --> N[Запрос к GigaChat API]
    N --> O[Получение дайджеста]
    O --> P[Форматирование<br/>Markdown]
    P --> Q[Отправка дайджеста]
    
    L -->|Нет| R[Fallback-дайджест<br/>из шаблона]
    R --> Q
    
    Q --> S[Пользователь видит<br/>дайджест]
    
    style A fill:#e1f5ff
    style Q fill:#c8e6c9
    style S fill:#fff9c4
    style N fill:#f48fb1
```

---

## 4. СЦЕНАРИЙ: АВТОМАТИЧЕСКОЕ ИЗВЛЕЧЕНИЕ ЗАДАЧ

```mermaid
graph TD
    A[Сообщение в групповом чате] -->|Событие| B{Бот упомянут?}
    
    B -->|Нет| C[Тихая обработка<br/>в фоне]
    B -->|Да| D[Обработка с ответом]
    
    C --> E[Сохранение сообщения]
    D --> E
    
    E --> F{GigaChat<br/>доступен?}
    
    F -->|Нет| G[Пропуск извлечения]
    F -->|Да| H[Получение контекста:<br/>10 последних сообщений]
    H --> I[Получение существующих задач]
    I --> J[Формирование промпта<br/>для ИИ]
    J --> K[Запрос к GigaChat:<br/>extractTasks]
    
    K --> L[Парсинг ответа ИИ]
    L --> M{Задачи<br/>найдены?}
    
    M -->|Нет| N[Завершение]
    M -->|Да| O[Парсинг дат<br/>через chrono-node]
    O --> P[Сохранение задач в БД]
    P --> Q[Создание напоминаний]
    Q --> R[Планирование отправки]
    
    D --> S[Ответ в чат:<br/>найдены задачи]
    
    style A fill:#e1f5ff
    style K fill:#f48fb1
    style P fill:#c8e6c9
    style Q fill:#ffccbc
```

---

## 5. СЦЕНАРИЙ: ПЕРСОНАЛЬНЫЙ АССИСТЕНТ

```mermaid
graph TD
    A[Пользователь задает вопрос<br/>в личных сообщениях] -->|Текст| B{Активный чат<br/>выбран?}
    
    B -->|Нет| C[Предложение выбрать чат]
    C --> D[Показ списка чатов]
    
    B -->|Да| E[Получение контекста:<br/>100 последних сообщений]
    E --> F[Получение задач пользователя]
    F --> G[Получение материалов чата]
    G --> H[Получение участников чата]
    
    H --> I{GigaChat<br/>доступен?}
    
    I -->|Да| J[Формирование промпта<br/>с контекстом]
    J --> K[Запрос к GigaChat API]
    K --> L[Получение ответа ИИ]
    L --> M[Отправка ответа]
    
    I -->|Нет| N[Fallback-ответ<br/>из шаблона]
    N --> M
    
    M --> O[Пользователь получает<br/>ответ на вопрос]
    
    style A fill:#e1f5ff
    style K fill:#f48fb1
    style M fill:#c8e6c9
    style O fill:#fff9c4
```

---

## 6. СЦЕНАРИЙ: УПРАВЛЕНИЕ ЧАТАМИ

```mermaid
graph TD
    A[Пользователь:<br/>/chats или кнопка] -->|Действие| B[Получение списка чатов<br/>из БД]
    
    B --> C{Список<br/>пуст?}
    
    C -->|Да| D[Автоматическая синхронизация]
    C -->|Нет| E[Показ списка чатов]
    
    D --> F[Запрос к MAX API:<br/>getAllChats]
    F --> G[Для каждого чата:<br/>проверка членства]
    G --> H[Сохранение в БД]
    H --> I[Показ списка чатов]
    
    E --> J[Пользователь выбирает чат]
    I --> J
    
    J --> K[Установка активного чата]
    K --> L[Обновление UserPreference]
    L --> M[Подтверждение выбора]
    
    M --> N[Пользователь видит<br/>активный чат]
    
    style A fill:#e1f5ff
    style F fill:#c5e1f5
    style K fill:#c8e6c9
    style N fill:#fff9c4
```

---

## 7. СЦЕНАРИЙ: ПОИСК МАТЕРИАЛОВ И СООБЩЕНИЙ

```mermaid
graph TD
    A[Пользователь:<br/>/search запрос] -->|Команда| B[Извлечение запроса]
    B --> C{Активный чат<br/>выбран?}
    
    C -->|Нет| D[Предложение выбрать чат]
    C -->|Да| E[Параллельный поиск]
    
    E --> F[Поиск в материалах]
    E --> G[Поиск в сообщениях]
    
    F --> H[Фильтрация по запросу]
    G --> I[Фильтрация по запросу]
    
    H --> J[Дедупликация материалов]
    I --> K[Ограничение результатов]
    
    J --> L[Форматирование результатов]
    K --> L
    
    L --> M[Группировка:<br/>Материалы + Сообщения]
    M --> N[Markdown форматирование]
    N --> O[Отправка результатов]
    
    O --> P[Пользователь видит<br/>результаты поиска]
    
    style A fill:#e1f5ff
    style E fill:#90caf9
    style O fill:#c8e6c9
    style P fill:#fff9c4
```

---

## 8. СЦЕНАРИЙ: ЭКСПОРТ КАЛЕНДАРЯ

```mermaid
graph TD
    A[Пользователь:<br/>/calendar] -->|Команда| B{Пользователь<br/>авторизован?}
    
    B -->|Нет| C[Ошибка авторизации]
    B -->|Да| D[Получение персональных задач<br/>из всех чатов]
    
    D --> E{Задачи<br/>найдены?}
    
    E -->|Нет| F[Сообщение:<br/>нет задач]
    E -->|Да| G[Группировка по датам]
    
    G --> H[Формирование ICS-файла]
    H --> I[Добавление событий<br/>для каждой задачи]
    I --> J[Генерация файла]
    
    J --> K[Отправка ICS-файла]
    K --> L[Пользователь получает<br/>календарь для импорта]
    
    style A fill:#e1f5ff
    style H fill:#ffccbc
    style K fill:#c8e6c9
    style L fill:#fff9c4
```

---

## 9. СЦЕНАРИЙ: АВТОМАТИЧЕСКИЕ НАПОМИНАНИЯ

```mermaid
graph TD
    A[Задача создана<br/>с дедлайном] -->|Событие| B[Расчет времени напоминания:<br/>дедлайн минус 2 часа]
    
    B --> C[Создание Reminder в БД]
    C --> D[Планирование через<br/>node-schedule]
    
    D --> E[Ожидание времени]
    E --> F{Время<br/>наступило?}
    
    F -->|Нет| E
    F -->|Да| G[Получение задачи из БД]
    G --> H{Задача<br/>актуальна?}
    
    H -->|Нет| I[Пропуск напоминания]
    H -->|Да| J[Формирование текста<br/>напоминания]
    J --> K[Отправка в личные<br/>сообщения]
    K --> L[Отметка о доставке]
    
    L --> M[Пользователь получает<br/>напоминание]
    
    style A fill:#e1f5ff
    style D fill:#ffccbc
    style K fill:#c8e6c9
    style M fill:#fff9c4
```

---

## 10. СЦЕНАРИЙ: ОБРАБОТКА МАТЕРИАЛОВ

```mermaid
graph TD
    A[Сообщение с вложением] -->|Событие| B[Определение типа:<br/>файл/изображение/видео/ссылка]
    
    B --> C[Извлечение метаданных]
    C --> D[Установка названия:<br/>имя файла / фотка / видео]
    
    D --> E[Сохранение материала в БД]
    E --> F{Тип анализируемый?<br/>share или file}
    
    F -->|Да| G[Асинхронный анализ<br/>через GigaChat]
    F -->|Нет| H[Завершение]
    
    G --> I[Запрос к GigaChat:<br/>analyzeMaterial]
    I --> J[Получение описания]
    J --> K[Обновление материала<br/>в БД]
    
    K --> L[Материал готов<br/>к использованию]
    
    style A fill:#e1f5ff
    style G fill:#f48fb1
    style E fill:#c8e6c9
    style L fill:#fff9c4
```

---

## 11. СЦЕНАРИЙ: ПРОСМОТР ДЕДЛАЙНОВ

```mermaid
graph TD
    A[Пользователь:<br/>/deadlines] -->|Команда| B{Активный чат<br/>выбран?}
    
    B -->|Нет| C[Предложение выбрать чат]
    B -->|Да| D[Получение задач<br/>на ближайшие 7 дней]
    
    D --> E{Задачи<br/>найдены?}
    
    E -->|Нет| F[Сообщение:<br/>нет дедлайнов]
    E -->|Да| G[Сортировка по дате]
    G --> H[Форматирование списка]
    H --> I[Отправка списка дедлайнов]
    
    I --> J[Пользователь видит<br/>дедлайны]
    
    style A fill:#e1f5ff
    style I fill:#c8e6c9
    style J fill:#fff9c4
```

---

## 12. СЦЕНАРИЙ: ПРОСМОТР МАТЕРИАЛОВ

```mermaid
graph TD
    A[Пользователь:<br/>/materials] -->|Команда| B{Активный чат<br/>выбран?}
    
    B -->|Нет| C[Предложение выбрать чат]
    B -->|Да| D[Получение всех материалов<br/>из БД]
    
    D --> E[Дедупликация<br/>по ссылке/названию]
    E --> F{Материалы<br/>найдены?}
    
    F -->|Нет| G[Сообщение:<br/>нет материалов]
    F -->|Да| H[Форматирование:<br/>Markdown ссылки]
    H --> I[Отправка списка материалов]
    
    I --> J[Пользователь видит<br/>материалы]
    
    style A fill:#e1f5ff
    style I fill:#c8e6c9
    style J fill:#fff9c4
```

---

## 13. ЗАВИСИМОСТИ МЕЖДУ СЕРВИСАМИ

```mermaid
graph LR
    A[App] -->|использует| B[Message Service]
    A -->|использует| C[Task Service]
    A -->|использует| D[Digest Service]
    A -->|использует| E[Assistant Service]
    A -->|использует| F[Search Service]
    A -->|использует| G[Calendar Service]
    A -->|использует| H[Reminder Service]
    A -->|использует| I[User Chat Service]
    
    B -->|сохраняет| J[(PostgreSQL)]
    C -->|сохраняет| J
    C -->|использует| K[GigaChat Service]
    D -->|использует| K
    E -->|использует| K
    F -->|читает| J
    G -->|читает| J
    H -->|читает| J
    H -->|планирует| L[Node Schedule]
    I -->|сохраняет| J
    
    K -->|запросы| M[GigaChat API]
    A -->|запросы| N[MAX API]
    
    style A fill:#90caf9
    style J fill:#ffccbc
    style K fill:#f48fb1
    style M fill:#f48fb1
    style N fill:#c5e1f5
```

---

## 14. ПОТОК ДАННЫХ: ОТ СООБЩЕНИЯ ДО ХРАНЕНИЯ

```mermaid
graph TD
    A[MAX Messenger] -->|Webhook/Polling| B[Bot App]
    B -->|Парсинг| C[Message Service]
    
    C -->|Извлечение| D[Task Service]
    C -->|Извлечение| E[Material Service]
    C -->|Проверка важности| F[Important Message Service]
    C -->|Сохранение| G[(Message Table)]
    
    D -->|Запрос к ИИ| H[GigaChat Service]
    H -->|Ответ| D
    D -->|Сохранение| I[(Task Table)]
    D -->|Создание| J[Reminder Service]
    J -->|Сохранение| K[(Reminder Table)]
    
    E -->|Анализ через ИИ| H
    E -->|Сохранение| L[(Material Table)]
    
    F -->|Запрос к ИИ| H
    F -->|Уведомления| B
    
    I -->|Чтение| M[Digest Service]
    G -->|Чтение| M
    L -->|Чтение| M
    M -->|Запрос к ИИ| H
    H -->|Ответ| M
    M -->|Отправка| B
    
    N[Scheduled Digest Service] -->|Планирование| O[Node Schedule]
    O -->|Запуск| M
    
    style A fill:#c5e1f5
    style B fill:#90caf9
    style H fill:#f48fb1
    style G fill:#ffccbc
    style I fill:#ffccbc
    style L fill:#ffccbc
    style F fill:#fff9c4
```

---

## 15. ОБРАБОТКА ОШИБОК И FALLBACK

```mermaid
graph TD
    A[Любая операция] -->|Запрос| B{Внешний сервис<br/>доступен?}
    
    B -->|Да| C[Выполнение операции]
    B -->|Нет| D{Fallback<br/>доступен?}
    
    D -->|Да| E[Использование Fallback]
    D -->|Нет| F[Ошибка пользователю]
    
    C -->|Успех| G[Результат]
    C -->|Ошибка| H[Логирование ошибки]
    H --> I{Критичная<br/>ошибка?}
    
    I -->|Да| F
    I -->|Нет| E
    
    E --> G
    G --> J[Отправка пользователю]
    
    style A fill:#e1f5ff
    style C fill:#c8e6c9
    style E fill:#fff9c4
    style F fill:#ef5350
    style H fill:#ffccbc
```

---

## 16. АВТОМАТИЧЕСКАЯ СИНХРОНИЗАЦИЯ ЧАТОВ

```mermaid
graph TD
    A[Пользователь открывает<br/>раздел Мои чаты] -->|Действие| B[Автоматическая синхронизация]
    
    B --> C[Запрос к MAX API:<br/>getAllChats]
    C --> D{Ответ<br/>получен?}
    
    D -->|Нет| E[Ошибка синхронизации]
    D -->|Да| F[Для каждого чата]
    
    F --> G[Проверка членства<br/>через getChatMembers]
    G --> H{Пользователь<br/>является участником?}
    
    H -->|Нет| I[Пропуск чата]
    H -->|Да| J[Сохранение/обновление<br/>в UserChat]
    
    I --> K{Еще чаты?}
    J --> K
    
    K -->|Да| F
    K -->|Нет| L[Показ списка чатов]
    
    L --> M[Пользователь видит<br/>актуальный список]
    
    style A fill:#e1f5ff
    style C fill:#c5e1f5
    style J fill:#c8e6c9
    style M fill:#fff9c4
```

---

## 17. ИНТЕГРАЦИЯ С GIGACHAT

```mermaid
graph TD
    A[Запрос к GigaChat] -->|Действие| B{Токен<br/>в кэше?}
    
    B -->|Да| C{Токен<br/>валиден?}
    B -->|Нет| D[Получение токена]
    
    C -->|Да| E[Использование токена]
    C -->|Нет| D
    
    D --> F{Тип авторизации?}
    F -->|Authorization Key| G[Bearer Token<br/>в заголовке]
    F -->|Client ID/Secret| H[OAuth2<br/>в теле запроса]
    
    G --> I[Запрос к /api/v2/oauth]
    H --> I
    
    I --> J{Успех?}
    J -->|Нет| K[Retry с другим endpoint]
    K --> L{Retry<br/>успешен?}
    L -->|Да| M[Сохранение токена]
    L -->|Нет| N[Ошибка авторизации]
    
    J -->|Да| M
    M --> E
    
    E --> O[Запрос к /api/v1/chat/completions]
    O --> P[Получение ответа]
    P --> Q[Возврат результата]
    
    style A fill:#e1f5ff
    style I fill:#f48fb1
    style O fill:#f48fb1
    style Q fill:#c8e6c9
```

---

## 18. ОСНОВНЫЕ КОМАНДЫ И ИХ ПОТОКИ

```mermaid
graph TD
    A[Пользователь] -->|Команды| B{Тип команды}
    
    B -->|/start| C[Приветствие + меню]
    B -->|/help| D[Справка]
    B -->|/digest| E[Дайджест]
    B -->|/deadlines| F[Дедлайны]
    B -->|/calendar| G[Календарь]
    B -->|/search| H[Поиск]
    B -->|/materials| I[Материалы]
    B -->|/tasks| J[Задачи]
    B -->|/chats| K[Чаты]
    B -->|Вопрос| L[Ассистент]
    
    E --> M[GigaChat]
    L --> M
    J --> N[(БД)]
    F --> N
    G --> N
    H --> N
    I --> N
    K --> O[MAX API]
    
    style A fill:#e1f5ff
    style M fill:#f48fb1
    style N fill:#ffccbc
    style O fill:#c5e1f5
```

---

## 19. СЦЕНАРИЙ: ОПРЕДЕЛЕНИЕ ВАЖНЫХ СООБЩЕНИЙ

```mermaid
graph TD
    A[Сообщение в групповом чате] -->|Событие| B[Important Message Service<br/>checkIfImportant]
    
    B --> C[Эвристический анализ]
    C --> D{Ключевые слова<br/>найдены?}
    
    D -->|Да| E[Расчет эвристического балла]
    D -->|Нет| F[Проверка через GigaChat]
    
    E --> G{Балл >= 3?}
    G -->|Да| H[Важное сообщение]
    G -->|Нет| F
    
    F --> I{GigaChat<br/>доступен?}
    I -->|Да| J[Запрос к GigaChat API]
    I -->|Нет| K[Пропуск анализа]
    
    J --> L{Важное?}
    L -->|Да| H
    L -->|Нет| K
    
    H --> M[Определение приоритета]
    M --> N[Уведомление пользователей<br/>в личных сообщениях]
    
    N --> O[Пользователи получают<br/>уведомление о важном сообщении]
    
    style A fill:#e1f5ff
    style J fill:#f48fb1
    style H fill:#fff9c4
    style N fill:#c8e6c9
    style O fill:#fff9c4
```

## 20. СЦЕНАРИЙ: ЗАПЛАНИРОВАННЫЕ ДАЙДЖЕСТЫ

```mermaid
graph TD
    A[Пользователь настраивает<br/>расписание дайджеста] -->|Cron выражение| B[Сохранение в UserPreference]
    
    B --> C[Scheduled Digest Service<br/>scheduleDigest]
    C --> D[Создание задачи<br/>node-schedule]
    D --> E[Сохранение в памяти]
    
    E --> F[Ожидание времени]
    F --> G{Время<br/>наступило?}
    
    G -->|Нет| F
    G -->|Да| H[Получение настроек<br/>из UserPreference]
    
    H --> I[Digest Service<br/>generateDigest]
    I --> J[Генерация дайджеста]
    J --> K[Отправка в личные<br/>сообщения]
    
    K --> L[Пользователь получает<br/>дайджест по расписанию]
    
    M[Перезапуск бота] --> N[Восстановление<br/>запланированных дайджестов]
    N --> O[Загрузка из UserPreference]
    O --> D
    
    style A fill:#e1f5ff
    style I fill:#90caf9
    style K fill:#c8e6c9
    style L fill:#fff9c4
    style N fill:#ffccbc
```

## 21. СЦЕНАРИЙ: ЭКСПОРТ В EXCEL

```mermaid
graph TD
    A[Пользователь:<br/>/calendar] -->|Команда| B{Формат<br/>экспорта?}
    
    B -->|Excel| C[Calendar Service<br/>exportToExcel]
    B -->|ICS| D[Calendar Service<br/>exportToICS]
    
    C --> E[Получение персональных задач]
    E --> F[Создание ExcelJS Workbook]
    F --> G[Настройка колонок:<br/>Дата, Время, Название, и т.д.]
    G --> H[Добавление данных]
    H --> I[Стилизация заголовков]
    I --> J[Генерация .xlsx файла]
    J --> K[Отправка файла]
    
    D --> L[Генерация ICS-файла]
    L --> K
    
    K --> M[Пользователь получает<br/>календарь в выбранном формате]
    
    style A fill:#e1f5ff
    style C fill:#ffccbc
    style J fill:#c8e6c9
    style M fill:#fff9c4
```

## 22. ТЕСТИРОВАНИЕ И КАЧЕСТВО

### Автоматическое тестирование

Проект включает **49 автоматических тестов** на Jest:

**Покрытие тестами:**
- ✅ Утилиты (text, date, number) - 42 теста
- ✅ Сервисы (taskService, digestService) - 7 тестов
- ✅ Все тесты проходят успешно
- ✅ Время выполнения: ~6-13 секунд

**Запуск тестов:**
```bash
npm test              # Все тесты
npm run test:watch    # Режим watch
npm run test:coverage # С отчетом о покрытии
```

**Структура тестов:**
- `src/utils/__tests__/text.test.ts` - тесты утилит для работы с текстом
- `src/utils/__tests__/date.test.ts` - тесты утилит для работы с датами
- `src/utils/__tests__/number.test.ts` - тесты утилит для работы с числами
- `src/services/__tests__/taskService.test.ts` - тесты сервиса задач
- `src/services/__tests__/digestService.test.ts` - тесты сервиса дайджестов

---

## ЗАКЛЮЧЕНИЕ

Все сценарии показывают полный цикл взаимодействия пользователя с ботом, включая:
- Обработку команд и сообщений
- Интеграцию с внешними сервисами (MAX API, GigaChat)
- Работу с базой данных
- Обработку ошибок и fallback-механизмы
- Автоматические процессы (напоминания, синхронизация, важные сообщения, запланированные дайджесты)
- Экспорт данных в различные форматы (ICS, Excel)
- Автоматическое тестирование для обеспечения качества кода

Схемы можно использовать для:
- Презентации архитектуры
- Документирования функциональности
- Понимания зависимостей между компонентами
- Отладки и анализа проблем
- Разработки и поддержки тестов

