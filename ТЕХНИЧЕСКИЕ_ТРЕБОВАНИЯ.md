# ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ К ИТОГОВОМУ ПРОДУКТУ
## MAX Productivity Bot - AI-ассистент для мессенджера MAX

---

## 1. ОБЩИЕ ТРЕБОВАНИЯ

### 1.1. Назначение продукта
AI-ассистент для мессенджера MAX, который:
- Собирает дайджесты обсуждений в чатах
- Отслеживает дедлайны и задачи
- Напоминает о важных событиях в личных сообщениях
- Помогает студентам оперативно находить материалы
- Предоставляет персонального ИИ-ассистента для ответов на вопросы

### 1.2. Платформа
- **Мессенджер**: MAX (официальная платформа)
- **API**: MAX Bot API (`@maxhub/max-bot-api` версии `^0.2.1`)
- **Тип приложения**: Чат-бот (MVP)

---

## 2. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 2.1. Интеграция с MAX Messenger

#### 2.1.1. Групповые чаты
-  Бот должен работать в групповых чатах
-  Обрабатывать сообщения только при упоминании бота (`@bot`)
-  Автоматически добавлять чаты в список пользователя при отправке сообщения
-  Синхронизировать список чатов пользователя с MAX API
-  Проверять членство пользователя в чатах (конфиденциальность)

#### 2.1.2. Личные диалоги (DM)
-  Бот должен работать в личных сообщениях
-  Автоматически отвечать на вопросы пользователей
-  Отправлять напоминания о задачах
-  Отправлять запланированные дайджесты
-  Показывать приветственное сообщение при первом взаимодействии

### 2.2. Автоматический анализ переписки

#### 2.2.1. Дайджесты обсуждений
-  Команда `/digest` с поддержкой аргументов:
  - `today` / `сегодня` — дайджест за сегодня
  - `yesterday` / `вчера` — дайджест за вчера
  - `week` / `неделя` — дайджест за неделю
  - `YYYY-MM-DD` — дайджест за конкретную дату
  - `YYYY-MM-DD:YYYY-MM-DD` — дайджест за период
-  Генерация дайджестов через GigaChat с контекстом:
  - Ключевые темы обсуждения
  - Задачи и дедлайны (сгруппированные по датам)
  - Материалы (файлы, ссылки)
  - Активные участники и их роли
  - Рекомендации по дальнейшим действиям
-  Fallback-дайджест при недоступности GigaChat
-  Ограничение количества сообщений для анализа (`DIGEST_MAX_MESSAGES=200`)

#### 2.2.2. Выделение задач и дедлайнов
-  Автоматическое извлечение задач из сообщений через GigaChat
-  Контекстный анализ (не просто поиск дат, а понимание контекста)
-  Поддержка относительных дат:
  - "завтра", "послезавтра", "через неделю"
  - "today", "tomorrow", "in N days"
  - ISO8601 формат дат
-  Сохранение задач в БД с полями:
  - `title` — название задачи
  - `description` — описание (опционально)
  - `dueDate` — дедлайн (опционально)
  - `assigneeId` / `assigneeName` — исполнитель
  - `createdByUserId` / `createdByName` — создатель
  - `status` — статус (open, completed, cancelled)
  - `priority` — приоритет (low, medium, high)
-  Автоматическое создание напоминаний для задач
-  Команда `/deadlines` — дедлайны на ближайшие 7 дней
-  Команда `/tasks` — все задачи в чате

### 2.3. Персональный ИИ-ассистент

#### 2.3.1. Интеграция с GigaChat
-  Использование GigaChat API для:
  - Генерации дайджестов (`summarizeChat`)
  - Извлечения задач (`extractTasks`)
  - Анализа материалов (`analyzeMaterial`)
  - Ответов на вопросы (`complete`)
-  Поддержка двух методов авторизации:
  - `GIGACHAT_AUTHORIZATION_KEY` (Bearer token для физ. лиц)
  - `GIGACHAT_CLIENT_ID` + `GIGACHAT_CLIENT_SECRET` (OAuth2 для корпоративных)
-  Использование российских сертификатов CA для TLS
-  Кэширование токенов доступа
-  Retry-логика при ошибках API

#### 2.3.2. Ответы на вопросы
-  Обработка вопросов в личных сообщениях
-  Контекстный анализ с учетом:
  - Истории чата (до 100 последних сообщений)
  - Задач пользователя (предстоящие и все задачи в чате)
  - Материалов чата
  - Участников чата и их ролей
-  Fallback-ответы при недоступности GigaChat
-  Примеры вопросов:
  - "какие дедлайны завтра?"
  - "какие материалы к экзамену?"
  - "есть задачи на завтра?"

### 2.4. Личный календарь

#### 2.4.1. Экспорт календаря
-  Команда `/calendar` для экспорта календаря
-  Генерация ICS-файлов (стандарт iCalendar)
-  Генерация Excel-файлов с задачами (формат .xlsx)
-  Экспорт персональных задач пользователя:
  - Задачи, где пользователь — исполнитель (`assigneeId`)
  - Задачи, где пользователь — создатель (`createdByUserId`)
-  Период экспорта: ближайшие 60 дней
-  Совместимость с:
  - Google Calendar
  - Microsoft Outlook
  - Apple Calendar
  - Другими календарными приложениями
  - Microsoft Excel, Google Sheets (для Excel-формата)

### 2.5. Управление материалами

#### 2.5.1. Извлечение материалов
-  Автоматическое извлечение из сообщений:
  - Файлы (`type: "file"`) — название файла
  - Изображения (`type: "image"`) — "фотка"
  - Видео (`type: "video"`) — название видео
  - Ссылки (`type: "share"`) — заголовок ссылки
-  Сохранение метаданных:
  - `title` — название материала
  - `link` — ссылка на материал
  - `type` — тип материала
  - `fileName` — имя файла (если есть)
  - `fileType` — MIME-тип файла
  - `description` — краткое описание через ИИ (для анализируемых типов)

#### 2.5.2. Поиск и просмотр
-  Команда `/materials` — просмотр всех материалов чата
-  Команда `/search <запрос>` — поиск по материалам и сообщениям
-  Дедупликация материалов (одинаковые материалы показываются один раз)
-  Форматирование ссылок как Markdown: `[**название**](ссылка)`

### 2.6. Напоминания

#### 2.6.1. Автоматические напоминания
-  Автоматическое создание напоминаний для задач с дедлайнами
-  Напоминания отправляются в личные сообщения
-  Время напоминания: за 2 часа до дедлайна (настраивается через `reminderOffsetMinutes`)
-  Восстановление напоминаний при перезапуске бота
-  Отметка о доставке напоминаний

### 2.7. Важные сообщения

#### 2.7.1. Определение важных сообщений
-  Автоматическое определение важных сообщений через ИИ и эвристики
-  Критерии важности:
  - Наличие дедлайнов, задач, назначений
  - Срочность и приоритет
  - Упоминания пользователей
  - Вопросы, требующие ответа
-  Уведомление пользователей о важных сообщениях в личных сообщениях
-  Приоритизация важных сообщений (high, medium, low)

### 2.8. Запланированные дайджесты

#### 2.8.1. Автоматические дайджесты
-  Настройка расписания дайджестов через cron-выражения
-  Автоматическая генерация и отправка дайджестов по расписанию
-  Восстановление запланированных дайджестов при перезапуске бота
-  Периодическая проверка новых расписаний (каждый час)

### 2.9. Команды бота

#### 2.9.1. Основные команды
-  `/start` — приветственное сообщение с изображением и главным меню
-  `/help` — справка по возможностям бота
-  `/digest [период]` — дайджест обсуждений
-  `/deadlines` — дедлайны на ближайшие 7 дней
-  `/calendar` — экспорт дедлайнов в календарь
-  `/search <запрос>` — поиск по материалам и сообщениям
-  `/materials` — просмотр всех материалов чата
-  `/tasks` — все задачи в чате
-  `/chats` — выбор активного чата
-  `/select_chat <chat_id>` — выбор конкретного чата
-  `/sync_chats` — синхронизация списка чатов

---

## 3. ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ

### 3.1. Технологический стек

#### 3.1.1. Язык программирования
-  **TypeScript** версии `^5.9.3`
-  Строгая типизация (`strict: true`)
-  ES2022 target
-  CommonJS модули

#### 3.1.2. Runtime
-  **Node.js** версии `20` или выше
-  Поддержка `node:20-slim` в Docker

#### 3.1.3. Основные зависимости
-  `@maxhub/max-bot-api` версии `^0.2.1` — официальная библиотека MAX Bot API
-  `@prisma/client` версии `^6.19.0` — ORM для работы с БД
-  `axios` версии `^1.13.2` — HTTP-клиент для GigaChat API
-  `chrono-node` версии `^2.9.0` — парсинг дат
-  `dayjs` версии `^1.11.19` — работа с датами
-  `ics` версии `^3.8.1` — генерация ICS-файлов
-  `exceljs` версии `^4.4.0` — генерация Excel-файлов
-  `node-schedule` версии `^2.1.1` — планирование задач
-  `pino` версии `^10.1.0` — логирование
-  `zod` версии `^4.1.12` — валидация конфигурации

### 3.2. База данных

#### 3.2.1. СУБД
-  **PostgreSQL** версии `16`
-  Поддержка через Prisma ORM

#### 3.2.2. Схема данных
-  **Message** — сообщения из чатов
  - Индексы: `(chatId, timestamp)`, `(senderId, timestamp)`
-  **Task** — задачи и дедлайны
  - Индексы: `(chatId, dueDate)`, `(chatId, status)`, `(assigneeId, dueDate)`, `(createdByUserId, dueDate)`, `(status, dueDate)`
  - Уникальность: `(sourceMessageId, title)`
-  **Reminder** — напоминания
  - Связь с Task через foreign key
-  **Material** — материалы (файлы, ссылки, изображения)
  - Индексы: `(chatId, createdAt)`, `(chatId, type)`, `(chatId, link)`, `(link)`
-  **UserPreference** — настройки пользователя
  - Часовой пояс, настройки напоминаний, расписание дайджестов
-  **UserChat** — связь пользователей с чатами
  - Уникальность: `(userId, chatId)`
  - Индекс: `(userId)`
-  **DigestLog** — логи сгенерированных дайджестов
  - Индексы: `(chatId, createdAt)`, `(chatId, generatedFor)`

#### 3.2.3. Миграции
-  Использование Prisma Migrate для версионирования схемы
-  Автоматическое применение миграций при запуске (Docker Compose)
-  Миграции в папке `prisma/migrations/`

### 3.3. Архитектура приложения

#### 3.3.1. Структура проекта
```
src/
├── app.ts                    # Основной файл с логикой бота
├── config.ts                 # Конфигурация приложения
├── db.ts                     # Подключение к БД
├── index.ts                  # Точка входа
├── logger.ts                 # Логирование
├── types.ts                  # TypeScript типы
├── services/                 # Сервисы
│   ├── assistantService.ts        # Персональный ассистент
│   ├── calendarService.ts         # Экспорт календаря (ICS и Excel)
│   ├── digestService.ts           # Генерация дайджестов
│   ├── gigachatService.ts         # Интеграция с GigaChat
│   ├── importantMessageService.ts # Определение важных сообщений
│   ├── keyboardService.ts         # Клавиатуры бота (UI)
│   ├── messageService.ts          # Обработка сообщений
│   ├── preferenceService.ts       # Настройки пользователя
│   ├── reminderService.ts         # Напоминания
│   ├── scheduledDigestService.ts  # Запланированные дайджесты
│   ├── searchService.ts           # Поиск
│   ├── taskService.ts             # Задачи
│   └── userChatService.ts         # Управление чатами
└── utils/                    # Утилиты
    ├── date.ts              # Работа с датами
    ├── ids.ts               # Нормализация ID
    ├── number.ts            # Работа с числами
    └── text.ts              # Обработка текста
```

#### 3.3.2. Принципы архитектуры
-  Разделение на сервисы (Service Layer)
-  Dependency Injection через экспорт экземпляров сервисов
-  Обработка ошибок на всех уровнях
-  Структурированное логирование
-  Типобезопасность через TypeScript

### 3.4. Интеграции

#### 3.4.1. MAX Bot API
-  Использование официальной библиотеки `@maxhub/max-bot-api`
-  Polling для получения обновлений
-  Обработка событий: `message_created`, `bot_started`
-  Отправка сообщений с вложениями (изображения, клавиатуры)
-  Получение информации о чатах и участниках

#### 3.4.2. GigaChat API
-  Авторизация через OAuth2 или Bearer token
-  Использование российских сертификатов CA
-  Поддержка моделей: `GigaChat-Pro` (настраивается)
-  Endpoints:
  - `/api/v2/oauth` — получение токена
  - `/api/v1/chat/completions` — генерация ответов
-  Retry-логика при ошибках
-  Кэширование токенов доступа

### 3.5. Конфигурация

#### 3.5.1. Переменные окружения (обязательные)
-  `MAX_BOT_TOKEN` — токен бота из Master Bot / PrimeBot
-  `DATABASE_URL` — строка подключения к PostgreSQL

#### 3.5.2. Переменные окружения (опциональные)
-  `GIGACHAT_AUTHORIZATION_KEY` — ключ авторизации GigaChat (для физ. лиц)
-  `GIGACHAT_CLIENT_ID` + `GIGACHAT_CLIENT_SECRET` — OAuth2 credentials (для корпоративных)
-  `GIGACHAT_SCOPE` — область доступа (по умолчанию: `GIGACHAT_API_PERS`)
-  `GIGACHAT_AUTH_URL` — URL авторизации (по умолчанию: `https://ngw.devices.sberbank.ru:9443/api/v2/oauth`)
-  `GIGACHAT_BASE_URL` — базовый URL API (по умолчанию: `https://gigachat.devices.sberbank.ru/api/v1`)
-  `GIGACHAT_MODEL` — модель для использования (по умолчанию: `GigaChat-Pro`)
-  `GIGACHAT_CA_CERT_PATH` — путь к сертификатам CA (разделитель: `;`)
-  `GIGACHAT_TLS_INSECURE` — отключение проверки TLS (только для разработки)
-  `DEFAULT_TIMEZONE` — часовой пояс (по умолчанию: `Europe/Moscow`)
-  `DIGEST_MAX_MESSAGES` — максимальное количество сообщений для дайджеста (по умолчанию: `200`)
-  `LOG_LEVEL` — уровень логирования (по умолчанию: `info`)

### 3.6. Развертывание

#### 3.6.1. Docker
-  **Dockerfile** с multi-stage build:
  - Stage `builder`: установка зависимостей, компиляция TypeScript
  - Stage `runner`: production-образ с минимальными зависимостями
-  Оптимизация размера образа:
  - Использование `node:20-slim`
  - Установка только production зависимостей (`--omit=dev`)
  - Копирование только необходимых файлов

#### 3.6.2. Docker Compose
-  Сервис `postgres`: PostgreSQL 16
  - Health checks
  - Volume для персистентности данных
  - Порт `5432`
-  Сервис `bot`: приложение бота
  - Зависимость от `postgres` (ожидание health check)
  - Автоматическое применение миграций при запуске
  - Restart policy: `unless-stopped`
  - DNS настройки для совместимости

#### 3.6.3. Миграции БД
-  Автоматическое применение при запуске: `npx prisma migrate deploy`
-  Миграции версионированы в `prisma/migrations/`
-  Lock файл для предотвращения конфликтов

### 3.7. Логирование

#### 3.7.1. Структурированное логирование
-  Использование библиотеки `pino`
-  Уровни логирования: `debug`, `info`, `warn`, `error`
-  Структурированные логи с контекстом:
  - `userId` — ID пользователя
  - `chatId` — ID чата
  - `action` — действие
  - `location` — место в коде
  - `error` — информация об ошибке

#### 3.7.2. Методы логирования
-  `logger.userAction()` — действия пользователя
-  `logger.command()` — выполнение команд
-  `logger.error()` — ошибки
-  `logger.success()` — успешные операции
-  `logger.warn()` — предупреждения
-  `logger.system()` — системные события
-  `logger.debug()` — отладочная информация

### 3.8. Обработка ошибок

#### 3.8.1. Принципы
-  Try-catch блоки во всех критичных местах
-  Структурированное логирование ошибок
-  Fallback-механизмы при недоступности внешних сервисов
-  Graceful degradation (бот работает даже без GigaChat)

#### 3.8.2. Retry-логика
-  Retry для получения информации о боте при запуске
-  Retry для получения токена GigaChat
-  Retry для запросов к GigaChat API

### 3.9. Безопасность

#### 3.9.1. Хранение секретов
-  Все секреты в переменных окружения
-  Не хранить секреты в коде или Git
-  Использование `.env` файла (не коммитится)

#### 3.9.2. Конфиденциальность данных
-  Проверка членства пользователя в чатах
-  Пользователь может выбирать только чаты, в которых он состоит
-  Хранение только необходимых данных
-  Соблюдение требований MAX к чат-ботам

#### 3.9.3. TLS/SSL
-  Использование российских сертификатов CA для GigaChat
-  Проверка TLS сертификатов (кроме режима разработки)

### 3.10. Производительность

#### 3.10.1. Оптимизация БД
-  Индексы на часто используемых полях
-  Ограничение количества записей в запросах
-  Дедупликация материалов

#### 3.10.2. Оптимизация приложения
-  Предзагрузка изображения приветствия
-  Кэширование токенов GigaChat
-  Ограничение количества сообщений для анализа
-  Асинхронная обработка материалов через ИИ

### 3.11. Документация

#### 3.11.1. README.md
-  Описание проекта
-  Архитектура
-  Инструкции по запуску (Docker и локально)
-  Пример `.env` файла
-  Описание команд бота
-  Инструкции по настройке GigaChat

#### 3.11.2. Код
-  Комментарии в коде для сложных мест
-  JSDoc для публичных методов (где необходимо)

---

## 4. ТРЕБОВАНИЯ К АРТЕФАКТАМ

### 4.1. Docker-образ
-  Должен быть предоставлен рабочий Dockerfile
-  Образ должен собираться без ошибок
-  Образ должен быть оптимизирован для production

### 4.2. Инструкция по запуску
-  Подробная инструкция в README.md
-  Инструкции для Docker Compose
-  Инструкции для локального запуска
-  Примеры конфигурации

### 4.3. Миграции БД
-  Все миграции должны быть в папке `prisma/migrations/`
-  Миграции должны применяться автоматически
-  Схема БД должна быть актуальной

---

## 5. КРИТЕРИИ ПРИЕМКИ

### 5.1. Функциональность
-  Бот работает в групповых чатах и личных диалогах
-  Все команды работают корректно
-  Дайджесты генерируются с правильным форматированием
-  Задачи извлекаются из сообщений
-  Календарь экспортируется в правильном формате
-  Поиск работает по материалам и сообщениям

### 5.2. Надежность
-  Бот не падает при ошибках
-  Есть fallback-механизмы
-  Ошибки логируются корректно

### 5.3. Производительность
-  Бот отвечает в разумные сроки
-  БД запросы оптимизированы

### 5.4. Безопасность
-  Секреты не хранятся в коде
-  Конфиденциальность данных соблюдена

---

## 6. ДОПОЛНИТЕЛЬНЫЕ ТРЕБОВАНИЯ

### 6.1. Пользовательский интерфейс
-  Интерактивные клавиатуры (inline keyboards)
-  Главное меню с кнопками
-  Обновление сообщений вместо создания новых
-  Приветственное сообщение с изображением

### 6.2. Локализация
-  Интерфейс на русском языке
-  Поддержка русских дат ("сегодня", "вчера", "завтра")
-  Форматирование дат в формате `DD.MM.YYYY`

### 6.3. Расширяемость
-  Модульная архитектура
-  Легко добавлять новые команды
-  Легко добавлять новые сервисы

---

## 7. ОГРАНИЧЕНИЯ И ЗАВИСИМОСТИ

### 7.1. Внешние зависимости
-  MAX Messenger API (обязательно)
-  GigaChat API (опционально, но рекомендуется)
-  PostgreSQL (обязательно)

### 7.2. Ограничения
-  Бот работает только в MAX Messenger
-  Требуется токен бота из Master Bot / PrimeBot
-  Для полного функционала требуется GigaChat API ключ

---

## 8. ТЕСТИРОВАНИЕ

### 8.1. Реализованные тесты

**Автоматические тесты (Jest):**
- ✅ Unit-тесты для утилит (`text`, `date`, `number`) - 42 теста
- ✅ Unit-тесты для критичных сервисов (`taskService`, `digestService`) - 7 тестов
- ✅ Всего: **49 автоматических тестов**
- ✅ Все тесты проходят успешно
- ⏱️ Время выполнения: ~6-13 секунд

**Структура тестов:**
- `src/utils/__tests__/text.test.ts` - тесты утилит для работы с текстом
- `src/utils/__tests__/date.test.ts` - тесты утилит для работы с датами
- `src/utils/__tests__/number.test.ts` - тесты утилит для работы с числами
- `src/services/__tests__/taskService.test.ts` - тесты сервиса задач
- `src/services/__tests__/digestService.test.ts` - тесты сервиса дайджестов

**Запуск тестов:**
```bash
npm test              # Запустить все тесты
npm run test:watch    # Режим watch
npm run test:coverage # С отчетом о покрытии
```

**Планы по расширению:**
- Integration-тесты для работы с БД через Prisma
- E2E-тесты для основных сценариев использования
- Расширение покрытия тестами других сервисов

---

## 9. ЗАКЛЮЧЕНИЕ

Все технические требования выполнены. Проект готов к развертыванию и использованию.

